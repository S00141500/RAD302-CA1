@{
    ViewBag.Title = "Home Page";
}

<div class="row">
    <div class="col-md-12">

        <div id="leagueIcons" class="col-md-1">
            <ul data-bind="foreach:leagues">
                <li>
                    <a href="#" data-bind="click : $root.showLeagueData"><img data-bind="attr:{src:LeagueIcon, alt:LeagueName}" width="50" height="50" /></a>
                </li>
            </ul>

        </div>

        <div class="col-md-push-1 col-md-10">
            <ul class="nav nav-tabs">
                <li class="active bg-success"><a href="#fixtures" data-toggle="tab" aria-expanded="true">Fixtures</a></li>
                <li class=""><a href="#standings" data-toggle="tab" aria-expanded="false">League Standings</a></li>
            </ul>
            <div id="myTabContent" class="tab-content">
                <div class="tab-pane fade active in" id="fixtures">
                    <table id="fixtures-table" class="table table-striped table-hover table-responsive table-condensed ">
                        <thead>
                            <tr>
                                <th>Home Team</th>
                                <th></th>
                                <th>Away Team</th>
                                <th>Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach:fixtures">
                            <tr>
                                <td data-bind="text:homeTeamName"></td>
                                <td><i class="glyphicon glyphicon-menu-down"></i></td>
                                <td data-bind="text:awayTeamName"></td>
                                <td ><i class="glyphicon glyphicon-calendar"></i><span data-bind="text:date"></span></td>
                                <td><button class="btn btn-sm btn-success" data-bind="click:$root.headToHead">Head to Head</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="standings">
                    <table class="table table-striped table-hover table-responsive table-condensed ">
                        <thead class="text-center">
                            <tr>
                                <th>#</th>
                                <th class="text-left">Team</th>
                                <th>Played</th>
                                <th>Won</th>
                                <th>Draw</th>
                                <th>Loss</th>
                                <th>Goals</th>
                                <th>Against</th>
                                <th>Goal Diff</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach:leagueStandings">
                            <tr>
                                <td data-bind="text:position"></td>
                                <td class="text-left"><img id="standing-crest-img" data-bind="attr:{src:crestURI}" width="20" height="20"/><span data-bind="text:teamName"></span></td>
                                <td data-bind="text:playedGames"></td>
                                <td data-bind="text:wins"></td>
                                <td data-bind="text:draws"></td>
                                <td data-bind="text:losses"></td>
                                <td data-bind="text:goals"></td>
                                <td data-bind="text:goalsAgainst"></td>
                                <td data-bind="text:goalDifference"></td>
                                <td data-bind="text:points"></td>

                            </tr>
                        </tbody>
                    </table>
                </div>
                
            </div>
        </div>

    </div>
</div>
<div class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Head to Head</h4>
            </div>
            <div class="modal-body">
                <p>Last 5 maches they faced each-other.</p>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>


@section scripts {

    @Scripts.Render("~/bundles/KO")

    <script>


        var fixturesViewModel = function () {

            var self = this;

            self.leagues = ko.observableArray();
            self.leagueStandings = ko.observableArray();
            self.fixtures = ko.observableArray();
            self.headToHeadList = ko.observableArray();

            // my api
            var leagueUri = 'http://localhost:11035//api/leagues';

            // external api
            var apiToken = 'ba5634ed8cc74a94abaa10b8b43e2fab';
            var externalUri = 'http://api.football-data.org/v1';


            function getLeaguesData() {
                ajaxHelper(leagueUri, 'GET').done(function (data) {

                    self.leagues(data);
                });
            }

            self.showLeagueData = function (l) {

                getLeagueFixtures(l.ID);
                getLeagueStandings(l.ID);

            }

            getLeaguesData();


            function ajaxHelper(uri, method, token, data) {
                return $.ajax({
                    headers: { 'X-Auth-Token': token },
                    //type: method,
                    url: uri,
                    dataType: 'json',
                    //contentType: 'application/json; charset=utf-8',
                    data: data ? JSON.stringify(data) : null
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    //toastr.error('Failed to get Data from Server!')
                });
            }

            self.headToHead = function (f) {
                alert(f.awayTeamName);
                ajaxHelper(externalUri + '/fixtures/'+id+'?head2head=d5', 'GET', apiToken).done(function (data) {
                    self.headToHeadList.removeAll();
                    self.headToHeadList(data);

                });

            }

            function getLeagueFixtures(id) {

                ajaxHelper(externalUri + '/soccerseasons/' + id + '/fixtures?timeFrame=n14', 'GET', apiToken).done(function (data) {
                     self.leagueStandings.removeAll();
                     self.fixtures(data.fixtures);
                   
                });

            }

            function getLeagueStandings(id) {
                ajaxHelper(externalUri + '/soccerseasons/' + id + '/leagueTable', 'GET', apiToken).done(function (data) {
                    self.leagueStandings.removeAll();
                    self.leagueStandings(data.standing);
                });
            }
        }


        $(document).ready(function () {

            ko.applyBindings(new fixturesViewModel());

        });



    </script>
}